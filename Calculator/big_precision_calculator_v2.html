<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Big Precision Calculator v2</title>
<style>
:root{
  --bg:#0b0f14; --panel:#111722; --glass:#0f1520; --btn:#1c2533; --btn-accent:#233146; --btn-op:#2a3a53; --text:#e6eefc; --muted:#93a4c3; --danger:#4a1f2a; --ok:#1f3a2a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{ margin:0; background:radial-gradient(1200px 800px at 50% -200px,#162033 0%, #0b0f14 60%); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; display:flex; align-items:center; justify-content:center; padding:12px; }
.app{ width:100%; max-width:520px; background:linear-gradient(180deg,var(--panel),var(--glass)); border:1px solid #1d2636; border-radius:20px; box-shadow: 0 10px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03); overflow:hidden; }
.top{ padding:16px 16px 0 16px; }
.title{ font-weight:700; letter-spacing:.3px; font-size:16px; color:#cfe0ff; display:flex; align-items:center; justify-content:space-between; gap:10px; }
.pill{ background:#0e1522; border:1px solid #1b2740; border-radius:999px; padding:6px 10px; font-size:12px; color:#cfe0ff; }
.subtitle{ font-size:12px; color:var(--muted); margin-top:4px; }
.display{ margin:12px 16px; background: #0e1522; border:1px solid #1b2740; border-radius:14px; padding:10px 12px; min-height:88px; display:flex; flex-direction:column; gap:6px; box-shadow: inset 0 4px 18px rgba(0,0,0,.35); }
.history{ min-height:20px; color:#9fb2d8; font-size:14px; overflow-x:auto; white-space:nowrap; scrollbar-width:none; }
.history::-webkit-scrollbar{display:none}
.current{ flex:1; font-size:28px; line-height:1.2; font-variant-numeric: tabular-nums; word-break: break-all; overflow-y:auto; max-height:140px; }
.controls{ display:flex; gap:10px; padding:0 16px 12px; align-items:center; flex-wrap:wrap; }
.controls label{ font-size:12px; color:var(--muted); }
.controls input[type="number"]{ width:100%; max-width:160px; background:#0e1522; border:1px solid #1b2740; color:var(--text); border-radius:10px; padding:8px 10px; font-size:14px; outline:none; }
.grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; padding:12px 16px 16px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0)); }
button{ appearance:none; border:none; border-radius:14px; padding:16px; font-size:18px; font-weight:700; color:var(--text); background:var(--btn); border:1px solid #23314a; box-shadow: 0 6px 14px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04); transition: transform .02s ease, background .15s ease; touch-action: manipulation; }
button:active{ transform: translateY(1px) scale(.995) }
.op{ background: var(--btn-op) }
.accent{ background: var(--btn-accent) }
.danger{ background: var(--danger) }
.ok{ background: #2a4f36 }
.span-2{ grid-column: span 2 }
.span-3{ grid-column: span 3 }
.footer{ padding:8px 16px 14px; color:var(--muted); font-size:12px; text-align:center; }
@media (max-width:380px){ .current{font-size:24px} button{padding:14px; font-size:17px} }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Big Precision Calculator v2">
    <div class="top">
      <div class="title">
        <span>Big Precision Calculator v2</span>
        <span class="pill" id="status">Auto‑save: ON</span>
      </div>
      <div class="subtitle">Arbitrary precision – thousands, tízezrek, akár 100k tizedes. Nincs tudományos jelölés.</div>
    </div>

    <div class="display" aria-live="polite">
      <div class="history" id="history"></div>
      <div class="current" id="display">0</div>
    </div>

    <div class="controls">
      <label for="prec">Precision (division digits):</label>
      <input id="prec" type="number" min="0" max="100000" step="100" value="5000" inputmode="numeric" />
      <label for="maxrender">Max render digits:</label>
      <input id="maxrender" type="number" min="1000" max="500000" step="1000" value="100000" inputmode="numeric" />
    </div>

    <div class="grid">
      <button class="danger" data-action="allclear">AC</button>
      <button class="accent" data-action="clear">CE</button>
      <button class="accent" data-action="back">⌫</button>
      <button class="op" data-op="divide">÷</button>

      <button data-num="7">7</button>
      <button data-num="8">8</button>
      <button data-num="9">9</button>
      <button class="op" data-op="multiply">×</button>

      <button data-num="4">4</button>
      <button data-num="5">5</button>
      <button data-num="6">6</button>
      <button class="op" data-op="minus">−</button>

      <button data-num="1">1</button>
      <button data-num="2">2</button>
      <button data-num="3">3</button>
      <button class="op" data-op="plus">+</button>

      <button data-action="negate">±</button>
      <button data-num="0">0</button>
      <button data-action="dot">.</button>
      <button class="ok" data-action="equals">=</button>

      <button class="accent span-2" data-action="factorial">n!</button>
      <button class="accent span-2" data-action="download">Save as .txt</button>
    </div>

    <div class="footer">
      Tipp: Osztáshoz állíts magasabb precisiont. <b>n!:</b> ha az eredmény nagyobb, mint a “Max render digits”, automatikus .txt letöltés a <i>teljes</i> számmal.
    </div>
  </div>

<script>
/* Persist */
const STORE_KEY="bigPrecisionCalcV2";
const historyEl=document.getElementById('history');
const displayEl=document.getElementById('display');
const precEl=document.getElementById('prec');
const maxrenderEl=document.getElementById('maxrender');
function saveState(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify({history:historyEl.textContent, current:displayEl.textContent, prec:precEl.value, maxrender:maxrenderEl.value})); }catch(e){} }
function loadState(){ try{ const raw=localStorage.getItem(STORE_KEY); if(!raw) return; const s=JSON.parse(raw); historyEl.textContent=s.history||""; displayEl.textContent=s.current||"0"; precEl.value=s.prec||"5000"; maxrenderEl.value=s.maxrender||"100000"; }catch(e){} }

/* Big decimal core (same as before) */
function norm(n){ let d=n.digits.replace(/^0+/,''); if(d.length===0) return {sign:1,digits:"0",scale:0}; while(n.scale>0 && d.endsWith('0')){ d=d.slice(0,-1); n.scale--; } return {sign:n.sign, digits:d, scale:n.scale}; }
function fromString(s){ s=(s+"").trim(); let sign=1; if(s[0]==='+'){s=s.slice(1);} else if(s[0]==='-'){sign=-1; s=s.slice(1);} if(!/^[0-9]*\.?[0-9]*$/.test(s)) throw new Error("Invalid"); if(s.includes('.')){ const [a,b='']=s.split('.'); const digits=(a.replace(/^0+/,'')+b).replace(/^$/,'0'); return norm({sign,digits,scale:b.length}); } const digits=s.replace(/^0+/,'').replace(/^$/,'0'); return norm({sign,digits,scale:0}); }
function toString(n){ n=norm({...n}); if(n.digits==="0") return "0"; const sgn=n.sign<0?"-":""; if(n.scale===0) return sgn+n.digits; const L=n.digits.length, i=L-n.scale; if(i>0) return sgn+n.digits.slice(0,i)+"."+n.digits.slice(i); return sgn+"0."+("0".repeat(-i))+n.digits; }
function align(a,b){ let sa=a.scale,sb=b.scale,da=a.digits,db=b.digits; if(sa<sb){ da=da+"0".repeat(sb-sa); sa=sb; }else if(sb<sa){ db=db+"0".repeat(sa-sb); sb=sa; } return {A:{sign:a.sign,digits:da,scale:sa},B:{sign:b.sign,digits:db,scale:sb},scale:sa}; }
function addDigits(x,y){ let i=x.length-1,j=y.length-1,c=0,o=""; while(i>=0||j>=0||c){ const dx=i>=0?x.charCodeAt(i)-48:0, dy=j>=0?y.charCodeAt(j)-48:0; const s=dx+dy+c; c=(s/10)|0; o=(s%10)+o; i--; j--; } return o.replace(/^0+/,'')||"0"; }
function subDigits(x,y){ let i=x.length-1,j=y.length-1,b=0,o=""; while(i>=0){ let dx=x.charCodeAt(i)-48-b, dy=j>=0?y.charCodeAt(j)-48:0; if(dx<dy){ dx+=10; b=1; } else b=0; o=(dx-dy)+o; i--; j--; } return o.replace(/^0+/,'')||"0"; }
function cmpDigits(x,y){ if(x.length!==y.length) return x.length>y.length?1:-1; if(x===y) return 0; return x>y?1:-1; }
function mulDigits(x,y){ if(x==="0"||y==="0") return "0"; const n=x.length,m=y.length,res=new Array(n+m).fill(0); for(let i=n-1;i>=0;i--){ const xi=x.charCodeAt(i)-48; for(let j=m-1;j>=0;j--){ const yj=y.charCodeAt(j)-48; const k=i+j+1, s=xi*yj+res[k]; res[k]=s%10; res[k-1]+= (s/10)|0; } } return res.join('').replace(/^0+/,'')||"0"; }
function divStep(rem,div){ let lo=0,hi=9,best=0; while(lo<=hi){ const mid=(lo+hi)>>1, prod=mulDigits(div,String(mid)); const c=cmpDigits(prod,rem); if(c<=0){ best=mid; lo=mid+1; } else hi=mid-1; } const newRem=subDigits(rem, mulDigits(div, String(best))); return {qDigit:best, rem:newRem}; }
function add(a,b){ a=norm({...a}); b=norm({...b}); const {A,B,scale}=align(a,b); if(a.sign===b.sign){ return norm({sign:a.sign,digits:addDigits(A.digits,B.digits),scale}); } const cmp=cmpDigits(A.digits,B.digits); if(cmp===0) return {sign:1,digits:"0",scale:0}; if(cmp>0) return norm({sign:a.sign,digits:subDigits(A.digits,B.digits),scale}); return norm({sign:b.sign,digits:subDigits(B.digits,A.digits),scale}); }
function neg(a){ return {sign:-a.sign,digits:a.digits,scale:a.scale}; }
function sub(a,b){ return add(a,neg(b)); }
function mul(a,b){ a=norm({...a}); b=norm({...b}); return norm({sign:a.sign*b.sign, digits:mulDigits(a.digits,b.digits), scale:a.scale+b.scale}); }
function div(a,b,precision){ a=norm({...a}); b=norm({...b}); if(b.digits==="0") throw new Error("Division by zero"); precision=Math.max(0, Math.min(100000, (precision|0))); const divs=b.digits; let rem="0", Q=""; for(let i=0;i<a.digits.length;i++){ rem=(rem==="0"?"":rem) + a.digits[i]; rem=rem.replace(/^0+/,'')||"0"; if(cmpDigits(rem,divs)<0){ Q+="0"; continue; } const {qDigit, rem:newR}=divStep(rem, divs); Q+=String(qDigit); rem=newR; } Q=Q.replace(/^0+/,'')||"0"; const scaleDiff=b.scale-a.scale; let digits, scale, integer="", frac=""; if(scaleDiff>=0){ integer=(Q==="0"?"0":Q)+"0".repeat(scaleDiff); }else{ const shiftL=-scaleDiff; const padded=Q.padStart(shiftL+1,'0'); const cut=padded.length-shiftL; integer=padded.slice(0,cut).replace(/^0+/,'')||"0"; frac=padded.slice(cut); } let produced=0; let R=rem; while(produced<precision && R!=="0"){ R=R+"0"; const {qDigit, rem:newR}=divStep(R, divs); frac += String(qDigit); R=newR; produced++; } if(frac.length===0){ digits= (integer||"0"); scale=0; } else { digits=(integer||"0")+frac; scale=frac.length; } return norm({sign:a.sign*b.sign, digits, scale}); }
/* Factorial helpers */
function digitsCountOfFactorial(n){ if(n<2) return 1; return Math.floor(n*Math.log10(n/Math.E) + 0.5*Math.log10(2*Math.PI*n)) + 1; }
async function factorialBigInt(n){ let res="1"; for(let i=2;i<=n;i++){ res=mulDigits(res, String(i)); if(i%25===0) await new Promise(r=>setTimeout(r,0)); } return res; }
function saveTextFile(filename, text){ const blob=new Blob([text],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0); }

/* Calculator state & UI */
let state={ x:fromString("0"), y:null, op:null, typing:false, error:null };
function show(n){ displayEl.textContent=toString(n); displayEl.scrollTop=displayEl.scrollHeight; saveState(); }
function setHistory(text){ historyEl.textContent=text||""; historyEl.scrollLeft=historyEl.scrollWidth; saveState(); }
function resetAll(){ state={x:fromString("0"),y:null,op:null,typing:false,error:null}; setHistory(""); show(state.x); }
function inputDigit(d){ let s=state.typing?displayEl.textContent:"0"; if(s==="0") s=""; s+=d; try{ const n=fromString(s); state.x=n; state.typing=true; show(n);}catch(e){} }
function inputDot(){ let s=state.typing?displayEl.textContent:"0"; if(!s.includes(".")) s+="."; try{ const n=fromString(s); state.x=n; state.typing=true; show(n);}catch(e){} }
function negate(){ state.x.sign*=-1; show(state.x); }
function backspace(){ let s=displayEl.textContent; if(!state.typing) s=toString(state.x); if(s.length<=1){ s="0"; } else { s=s.slice(0,-1); if(s==="-") s="0"; if(s.endsWith(".")) s=s.slice(0,-1); } state.x=fromString(s); state.typing=true; show(state.x); }
function setOp(op){ if(state.op && state.y){ equals(); return; } state.y=state.x; state.x=fromString("0"); state.op=op; state.typing=false; const sym={plus:"+",minus:"−",multiply:"×",divide:"÷"}[op]||"?"; setHistory(toString(state.y)+" "+sym); }
function equals(){ if(!state.op || state.y===null) return; try{ let r; if(state.op==="plus") r=add(state.y,state.x); else if(state.op==="minus") r=sub(state.y,state.x); else if(state.op==="multiply") r=mul(state.y,state.x); else if(state.op==="divide"){ const p=Math.max(0, Math.min(100000, parseInt(precEl.value||"0",10))); r=div(state.y,state.x,p); } setHistory(toString(state.y)+" "+({plus:"+",minus:"−",multiply:"×",divide:"÷"}[state.op])+" "+toString(state.x)+" ="); state.x=r; state.y=null; state.op=null; state.typing=false; show(r);}catch(e){ displayEl.textContent="Error: "+(e.message||""); setHistory(""); } }
async function doFactorial(){ const s=displayEl.textContent; if(s.includes('.')){ setHistory("n! csak egészre"); return; } const n=parseInt(s||"0",10); if(isNaN(n)||n<0){ setHistory("n! csak nemnegatív egész"); return; } const est = digitsCountOfFactorial(n); const cap = Math.max(1000, Math.min(500000, parseInt(maxrenderEl.value||"100000",10))); setHistory(n+"! számolás… ("+est.toLocaleString()+" számjegy várható)"); const digits = await factorialBigInt(n); if(digits.length>cap){ setHistory(n+"! kész • teljes eredmény .txt-be mentve"); displayEl.textContent="Kimenet túl nagy a megjelenítéshez ("+digits.length.toLocaleString()+" számjegy)."; saveTextFile("factorial_"+n+".txt", digits); } else { displayEl.textContent=digits; } state.x = fromString(digits); state.y=null; state.op=null; state.typing=false; saveState(); }
function downloadCurrent(){ const text=displayEl.textContent||""; if(!text){ setHistory("Nincs mit menteni"); return; } saveTextFile("big_precision_output.txt", text); }
/* Wiring */
document.querySelectorAll('button[data-num]').forEach(b=> b.addEventListener('click', ()=> inputDigit(b.dataset.num)));
document.querySelector('button[data-action="dot"]').addEventListener('click', inputDot);
document.querySelector('button[data-action="negate"]').addEventListener('click', negate);
document.querySelector('button[data-action="back"]').addEventListener('click', backspace);
document.querySelector('button[data-action="clear"]').addEventListener('click', ()=>{ state.x=fromString("0"); state.typing=false; show(state.x); });
document.querySelector('button[data-action="allclear"]').addEventListener('click', resetAll);
document.querySelector('button[data-action="equals"]').addEventListener('click', equals);
document.querySelectorAll('button[data-op]').forEach(b=> b.addEventListener('click', ()=> setOp(b.dataset.op)));
document.querySelector('[data-action="factorial"]').addEventListener('click', doFactorial);
document.querySelector('[data-action="download"]').addEventListener('click', downloadCurrent);
/* Keyboard */
window.addEventListener('keydown', (e)=>{
  if(e.key>='0'&&e.key<='9'){ inputDigit(e.key); }
  else if(e.key==='.'||e.key===','){ inputDot(); }
  else if(e.key==='+') setOp('plus');
  else if(e.key==='-') setOp('minus');
  else if(e.key==='*') setOp('multiply');
  else if(e.key==='/') setOp('divide');
  else if(e.key==='!' ){ doFactorial(); }
  else if(e.key==='Enter'||e.key==='='){ equals(); }
  else if(e.key==='Backspace'){ backspace(); }
  else if(e.key==='Escape'){ resetAll(); }
});
/* Auto-save */
[precEl,maxrenderEl].forEach(el=> el.addEventListener('input', saveState));
/* Restore */
loadState();
</script>
</body>
</html>
