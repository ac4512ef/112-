<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>System Calculator v13.0</title>

  <style>
    :root {
      --bg: #000; --calc-bg: #001100; --text: #0f0; --btn-bg: #002200; --btn-hover: #003300; --btn-active: #004400;
      --op-bg: #330000; --op-text: #f00; --eq-bg: #003300; --clear-bg: #500000; --mode-bg: #000033; --mode-text: #00f;
      --theme-bg: #111; --theme-text: #fff; --export-bg: #003300; --export-text: #0f0;
      --scrollbar: #0f0; --scrollbar-track: #001100; --border: #0f0; --glow: 0 0 25px rgba(0,255,0,0.6);
    }
    [data-theme="ocean"] {
      --bg: #001122; --calc-bg: #002233; --text: #00ffff; --btn-bg: #003344; --btn-hover: #004455; --btn-active: #005566;
      --op-bg: #330011; --op-text: #ff00ff; --eq-bg: #004444; --clear-bg: #550011; --mode-bg: #001133; --mode-text: #00aaff;
      --theme-bg: #112233; --theme-text: #fff; --export-bg: #004444; --export-text: #00ffff;
      --scrollbar: #00ffff; --scrollbar-track: #002233; --border: #00ffff; --glow: 0 0 25px rgba(0,255,255,0.6);
    }
    [data-theme="sunset"] {
      --bg: #220000; --calc-bg: #331100; --text: #ffcc00; --btn-bg: #442200; --btn-hover: #553300; --btn-active: #664400;
      --op-bg: #330000; --op-text: #ff6600; --eq-bg: #553300; --clear-bg: #550000; --mode-bg: #331100; --mode-text: #ffaa00;
      --theme-bg: #332211; --theme-text: #fff; --export-bg: #553300; --export-text: #ffcc00;
      --scrollbar: #ffcc00; --scrollbar-track: #331100; --border: #ffcc00; --glow: 0 0 25px rgba(255,204,0,0.6);
    }

    * { box-sizing: border-box; }
    body {
      font-family: 'Courier New', monospace;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      padding: 10px;
      transition: all 0.3s ease;
    }
    .calculator {
      background: var(--calc-bg);
      padding: 18px;
      border-radius: 20px;
      box-shadow: var(--glow), inset 0 0 12px rgba(0,0,0,0.5);
      width: 100%;
      max-width: 420px;
      border: 2px solid var(--border);
    }
    .mode {
      text-align: center;
      margin-bottom: 8px;
      font-weight: bold;
      font-size: 1.1em;
      color: var(--text);
    }
    .display {
      background: var(--calc-bg);
      color: var(--text);
      font-size: clamp(1.3em, 5vw, 1.7em);
      padding: 14px 16px;
      text-align: right;
      border-radius: 12px;
      margin-bottom: 12px;
      min-height: 50px;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      direction: ltr;
      border: 1px solid var(--border);
      box-shadow: inset 0 0 8px rgba(0,0,0,0.3);
      font-family: 'Courier New', monospace;
      letter-spacing: 1.2px;
      scrollbar-width: thin;
      scrollbar-color: var(--scrollbar) var(--scrollbar-track);
    }
    .display::-webkit-scrollbar { height: 6px; }
    .display::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 10px; }
    .display::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 10px; }

    .buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      padding: 5px;
    }
    @media (min-width: 500px) {
      .buttons { grid-template-columns: repeat(5, 1fr); }
    }

    button {
      padding: 12px 6px;
      font-size: clamp(0.9em, 2.8vw, 1.2em);
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--btn-bg);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      text-align: center;
    }
    button:hover { background: var(--btn-hover); transform: translateY(-1px); }
    button:active { background: var(--btn-active); transform: scale(0.96); }
    button.operator { background: var(--op-bg); border-color: var(--op-text); color: var(--op-text); }
    button.equals { background: var(--eq-bg); grid-column: span 2; }
    button.clear { background: var(--clear-bg); border-color: var(--op-text); color: var(--op-text); }
    button.mode-btn { background: var(--mode-bg); border-color: var(--mode-text); color: var(--mode-text); grid-column: span 2; }
    button.theme-btn { background: var(--theme-bg); color: var(--theme-text); }
    button.export-btn { background: var(--export-bg); color: var(--export-text); grid-column: 1 / -1; margin-top: 8px; }

    .hex-only { display: none; }
    .hex-only.show { display: block; }

    @media (max-width: 499px) {
      .hex-row { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; }
    }
  </style>
</head>
<body data-theme="matrix">

<div class="calculator">
  <div class="mode" id="mode">System: DEC</div>
  <div class="display" id="display">0</div>
  <div class="buttons" id="buttons">
    <button class="clear" onclick="clearDisplay()">C</button>
    <button onclick="deleteLast()">backspace</button>
    <button class="operator" onclick="appendOperator('/')">/</button>
    <button class="operator" onclick="appendOperator('*')">×</button>

    <button class="mode-btn" onclick="toggleMode()">System</button>
    <button class="theme-btn" onclick="cycleTheme()">Theme</button>

    <button onclick="appendToDisplay('7')">7</button>
    <button onclick="appendToDisplay('8')">8</button>
    <button onclick="appendToDisplay('9')">9</button>
    <button class="operator" onclick="appendOperator('-')">-</button>

    <button onclick="appendToDisplay('4')">4</button>
    <button onclick="appendToDisplay('5')">5</button>
    <button onclick="appendToDisplay('6')">6</button>
    <button class="operator" onclick="appendOperator('+')">+</button>

    <button onclick="appendToDisplay('1')">1</button>
    <button onclick="appendToDisplay('2')">2</button>
    <button onclick="appendToDisplay('3')">3</button>
    <button class="equals" onclick="calculate()">=</button>

    <button onclick="appendToDisplay('0')" style="grid-column: span 2;">0</button>
    <button onclick="appendToDisplay('.')">.</button>

    <div class="hex-row" id="hexRow" style="display: none; grid-column: 1 / -1;">
      <button class="hex-only" onclick="appendToDisplay('A')">A</button>
      <button class="hex-only" onclick="appendToDisplay('B')">B</button>
      <button class="hex-only" onclick="appendToDisplay('C')">C</button>
      <button class="hex-only" onclick="appendToDisplay('D')">D</button>
      <button class="hex-only" onclick="appendToDisplay('E')">E</button>
      <button class="hex-only" onclick="appendToDisplay('F')">F</button>
    </div>

    <button class="export-btn" onclick="exportToHTML()">Export</button>
  </div>
</div>

<script>
  // ====================== A TE DIV FÜGGVÉNYED (NAGY PONTOSSÁGÚ) ======================
  function N(sign, digits, scale) { return {sign, digits, scale}; }
  function fromString(s) {
    s = (s+"").trim(); let sign = 1;
    if (s.startsWith("-")) { sign = -1; s = s.slice(1); }
    const [intPart, decPart=""] = s.includes(".") ? s.split(".") : [s, ""];
    let digits = (intPart.replace(/^0+/,"") || "0") + decPart;
    if (decPart.length > 0) digits = digits.replace(/0+$/, "");
    return N(sign, digits || "0", decPart.length);
  }
  function toString(n) {
    if (n.digits === "0") return "0";
    const sgn = n.sign < 0 ? "-" : "";
    let d = n.digits, s = n.scale;
    if (d.length <= s) return sgn + "0." + "0".repeat(s - d.length) + d;
    const i = d.length - s;
    return sgn + d.slice(0, i) + (s > 0 ? "." : "") + d.slice(i);
  }
  function cmpDigits(a, b) { return a.length > b.length ? 1 : a.length < b.length ? -1 : a > b ? 1 : a < b ? -1 : 0; }
  function addDigits(a, b) {
    let i = a.length - 1, j = b.length - 1, c = 0, o = "";
    while (i >= 0 || j >= 0 || c) {
      const da = i >= 0 ? a.charCodeAt(i--) - 48 : 0;
      const db = j >= 0 ? b.charCodeAt(j--) - 48 : 0;
      const s = da + db + c; o = (s % 10) + o; c = (s / 10) | 0;
    }
    return o.replace(/^0+/, "") || "0";
  }
  function subDigits(a, b) {
    let i = a.length - 1, j = b.length - 1, c = 0, o = "";
    while (i >= 0) {
      let da = (a.charCodeAt(i--) - 48) - c, db = j >= 0 ? (b.charCodeAt(j--) - 48) : 0;
      if (da < db) { da += 10; c = 1; } else c = 0;
      o = (da - db) + o;
    }
    return o.replace(/^0+/, "") || "0";
  }
  function mulMaintenance(a, b) {
    if (a === "0" || b === "0") return "0";
    const n = a.length, m = b.length, res = new Array(n + m).fill(0);
    for (let i = n - 1; i >= 0; i--) {
      const ai = a.charCodeAt(i) - 48;
      for (let j = m - 1; j >= 0; j--) {
        const bj = b.charCodeAt(j) - 48, k = i + j + 1, s = ai * bj + res[k];
        res[k] = s % 10; res[k - 1] += (s / 10) | 0;
      }
    }
    return res.join("").replace(/^0+/, "") || "0";
  }
  function div(a, b, p) {
    if (b.digits === "0") throw new Error("Division by zero");
    let shift = p + b.scale - a.scale; if (shift < 0) shift = 0;
    let dividend = a.digits + "0".repeat(shift), divisor = b.digits, rem = "0", Q = "";
    for (let i = 0; i < dividend.length; i++) {
      rem = (rem === "0" ? "" : rem) + dividend[i]; rem = rem.replace(/^0+/, "") || "0";
      if (cmpDigits(rem, divisor) < 0) Q += "0";
      else {
        let lo = 1, hi = 9, best = 0;
        while (lo <= hi) {
          const mid = (lo + hi) >> 1, prod = mulMaintenance(divisor, String(mid));
          const c = cmpDigits(prod, rem);
          if (c <= 0) { best = mid; lo = mid + 1; } else hi = mid - 1;
        }
        const prod = mulMaintenance(divisor, String(best)), r = subDigits(rem, prod);
        Q += String(best); rem = r;
      }
    }
    Q = Q.replace(/^0+/, "") || "0";
    return N(a.sign * b.sign, Q, p);
  }
  // ========================================================================

  const display = document.getElementById('display');
  const modeText = document.getElementById('mode');
  const hexRow = document.getElementById('hexRow');
  const body = document.body;
  let mode = 'DEC';
  let internalExpr = '0';
  let lastResult = '';
  let history = [];
  const MAX_DIGITS = 100000;
  const PRECISION = 20000;
  const themes = ['matrix', 'ocean', 'sunset'];
  let currentTheme = 0;

  function updateDisplay() {
    const reversed = internalExpr.split('').reverse().join('');
    display.innerText = reversed || '0';
    requestAnimationFrame(() => display.scrollLeft = 0);
  }

  function loadState() {
    const saved = JSON.parse(localStorage.getItem('systemCalc') || '{}');
    mode = saved.mode || 'DEC';
    internalExpr = saved.expr || '0';
    lastResult = saved.result || '';
    history = saved.history || [];
    currentTheme = themes.indexOf(saved.theme || 'matrix');
    if (currentTheme === -1) currentTheme = 0;
    body.setAttribute('data-theme', themes[currentTheme]);
    updateMode();
    updateDisplay();
  }

  function saveState() {
    const state = { mode, expr: internalExpr, result: lastResult, history, theme: themes[currentTheme] };
    localStorage.setItem('systemCalc', JSON.stringify(state));
  }

  function appendToDisplay(value) {
    if (internalExpr === '0' && value !== '.') internalExpr = value;
    else if (internalExpr.length < MAX_DIGITS) internalExpr += value;
    lastResult = '';
    updateDisplay();
    saveState();
  }

  function appendOperator(op) {
    const lastChar = internalExpr.slice(-1);
    if (['+', '-', '*', '/', '×'].includes(lastChar)) {
      internalExpr = internalExpr.slice(0, -1);
    }

    const currentNumber = internalExpr.match(/[\d.]+$/);
    if (currentNumber) {
      const num = currentNumber[0];
      if (history.length === 0) {
        history = [`1 ${op === '/' ? '÷' : op} ${num}`];
      } else {
        const last = history[history.length - 1];
        if (last.includes('=')) {
          history = [`${lastResult} ${op === '/' ? '÷' : op} ${num}`];
        } else {
          history[history.length - 1] = last + ` ${op === '/' ? '÷' : op} ${num}`;
        }
      }
    }

    internalExpr += op;
    updateDisplay();
    saveState();
  }

  function clearDisplay() {
    internalExpr = '0'; lastResult = ''; history = [];
    updateDisplay(); saveState();
  }

  function deleteLast() {
    internalExpr = internalExpr.length > 1 ? internalExpr.slice(0, -1) : '0';
    updateDisplay(); saveState();
  }

  function toggleMode() {
    mode = mode === 'DEC' ? 'HEX' : 'DEC';
    updateMode();
    if (mode === 'DEC') {
      internalExpr = internalExpr.replace(/[A-F.]/gi, '');
      if (!internalExpr || internalExpr.match(/^[+\-*/×]$/)) internalExpr = '0';
    }
    updateDisplay();
    saveState();
  }

  function updateMode() {
    modeText.innerText = `System: ${mode}`;
    hexRow.style.display = mode === 'HEX' ? 'grid' : 'none';
  }

  function cycleTheme() {
    currentTheme = (currentTheme + 1) % themes.length;
    body.setAttribute('data-theme', themes[currentTheme]);
    saveState();
  }

  function calculate() {
    if (internalExpr === '0') return;

    try {
      let expr = internalExpr.replace(/×/g, '*').replace(/([+\-*/])$/, '');

      if (expr.match(/^[\d.]+(\/[\d.]+)+$/)) {
        const parts = expr.split('/');
        let result = fromString("1");
        for (let i = 1; i < parts.length; i++) {
          result = div(result, fromString(parts[i]), PRECISION);
        }

        let resultStr = toString(result);
        if (resultStr.length > 100) {
          resultStr = resultStr.slice(0, 100) + "...";
        }

        internalExpr = resultStr;
        lastResult = resultStr;

        const chain = `1 ÷ ${parts.slice(1).join(' ÷ ')} = ${resultStr}`;
        history = [chain];

      } else {
        let result;
        if (mode === 'HEX') {
          expr = expr.replace(/([0-9A-F]+)/gi, m => `0x${m}`);
          result = eval(expr.replace(/0x([0-9A-F]+)/gi, 'BigInt("0x$1")'));
          internalExpr = result.toString(16).toUpperCase();
        } else {
          result = eval(expr.replace(/\d+/g, n => `BigInt("${n}")`));
          internalExpr = result.toString();
        }
        lastResult = internalExpr;
        history.push(`= ${lastResult}`);
      }
    } catch (e) {
      internalExpr = 'ERROR';
      setTimeout(() => { if (internalExpr === 'ERROR') clearDisplay(); }, 2000);
    }

    if (internalExpr.length > MAX_DIGITS) {
      internalExpr = internalExpr.slice(0, MAX_DIGITS) + '...';
    }
    updateDisplay();
    saveState();
  }

  function exportToHTML() {
    const timestamp = new Date().toLocaleString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true });
    const historyLine = history.length > 0 ? history[history.length - 1] : 'No operations';
    const finalResult = lastResult || internalExpr;

    const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Calculator Result - ${timestamp}</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #000; color: #0f0; padding: 40px; text-align: center; }
    .container { max-width: 700px; margin: 0 auto; background: #001100; padding: 35px; border-radius: 18px; box-shadow: 0 0 30px rgba(0,255,0,0.3); border: 1px solid #0f0; }
    h1 { font-size: 2.4em; margin-bottom: 10px; color: #0f0; text-shadow: 0 0 10px #0f0; }
    .subtitle { color: #0a0; font-size: 1.1em; margin-bottom: 35px; border-bottom: 1px solid #0a0; padding-bottom: 12px; }
    .section { margin: 30px 0; text-align: left; }
    .label { font-weight: bold; color: #0f0; margin-bottom: 12px; font-size: 1.1em; }
    .history { background: #002200; padding: 18px; border-radius: 14px; font-family: 'Courier New', monospace; word-break: break-all; white-space: pre-wrap; }
    .result-box { background: #003300; padding: 25px; border-radius: 14px; font-size: 1.9em; font-weight: bold; margin: 25px 0; font-family: 'Courier New', monospace; color: #0f0; word-break: break-all; text-shadow: 0 0 8px #0f0; }
    .note { font-size: 0.95em; color: #0a0; margin-top: 25px; font-style: italic; line-height: 1.5; }
  </style>
</head>
<body>
  <div class="container">
    <h1>System<br>Calculator Result</h1>
    <div class="subtitle">Timestamp: ${timestamp}</div>

    <div class="section">
      <div class="label">Calculation History:</div>
      <div class="history">${historyLine}</div>
    </div>

    <div class="section">
      <div class="label">Final Result:</div>
      <div class="result-box">${finalResult}</div>
    </div>

    <div class="note">
      Note: This result was calculated with a division precision of ${PRECISION} digits using your custom string-based arithmetic.
    </div>
  </div>
</body>
</html>`;

    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `System_Calculator_Result_${Date.now()}.html`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Init
  loadState();
  window.addEventListener('beforeunload', saveState);
</script>

</body>
</html>