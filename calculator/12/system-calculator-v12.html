<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>System Calculator v12.0</title>
  <style>
    :root {
      --bg: #000; --calc-bg: #001100; --text: #0f0; --btn-bg: #002200; --btn-hover: #003300; --btn-active: #004400;
      --op-bg: #330000; --op-text: #f00; --eq-bg: #003300; --clear-bg: #500000; --mode-bg: #000033; --mode-text: #00f;
      --theme-bg: #111; --theme-text: #fff; --export-bg: #003300; --export-text: #0f0;
      --scrollbar: #0f0; --scrollbar-track: #001100; --border: #0f0; --glow: 0 0 25px rgba(0,255,0,0.6);
    }
    [data-theme="ocean"] {
      --bg: #001122; --calc-bg: #002233; --text: #00ffff; --btn-bg: #003344; --btn-hover: #004455; --btn-active: #005566;
      --op-bg: #330011; --op-text: #ff00ff; --eq-bg: #004444; --clear-bg: #550011; --mode-bg: #001133; --mode-text: #00aaff;
      --theme-bg: #112233; --theme-text: #fff; --export-bg: #004444; --export-text: #00ffff;
      --scrollbar: #00ffff; --scrollbar-track: #002233; --border: #00ffff; --glow: 0 0 25px rgba(0,255,255,0.6);
    }
    [data-theme="sunset"] {
      --bg: #220000; --calc-bg: #331100; --text: #ffcc00; --btn-bg: #442200; --btn-hover: #553300; --btn-active: #664400;
      --op-bg: #330000; --op-text: #ff6600; --eq-bg: #553300; --clear-bg: #550000; --mode-bg: #331100; --mode-text: #ffaa00;
      --theme-bg: #332211; --theme-text: #fff; --export-bg: #553300; --export-text: #ffcc00;
      --scrollbar: #ffcc00; --scrollbar-track: #331100; --border: #ffcc00; --glow: 0 0 25px rgba(255,204,0,0.6);
    }

    body {
      font-family: 'Courier New', monospace;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      transition: all 0.3s ease;
    }
    .calculator {
      background: var(--calc-bg);
      padding: 22px;
      border-radius: 20px;
      box-shadow: var(--glow), inset 0 0 12px rgba(0,0,0,0.5);
      width: 380px;
      max-width: 95vw;
      border: 2px solid var(--border);
    }
    .mode {
      text-align: center;
      margin-bottom: 8px;
      font-weight: bold;
      font-size: 1.1em;
      color: var(--text);
    }
    .display {
      background: var(--calc-bg);
      color: var(--text);
      font-size: clamp(1.2em, 4vw, 1.6em);
      padding: 16px 22px 16px 16px;
      text-align: right;
      border-radius: 12px;
      margin-bottom: 12px;
      min-height: 56px;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      direction: ltr;
      max-width: 100%;
      box-sizing: border-box;
      scrollbar-width: thin;
      scrollbar-color: var(--scrollbar) var(--scrollbar-track);
      font-family: 'Courier New', monospace;
      letter-spacing: 1.2px;
      border: 1px solid var(--border);
      box-shadow: inset 0 0 8px rgba(0,0,0,0.3);
    }
    .display::-webkit-scrollbar { height: 8px; }
    .display::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 10px; }
    .display::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 10px; }

    .buttons { display: grid; grid-template-columns: repeat(5, 1fr); gap: 11px; }
    button {
      padding: 14px 8px;
      font-size: clamp(1em, 3vw, 1.3em);
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--btn-bg);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      text-align: center;
    }
    button:hover { background: var(--btn-hover); transform: translateY(-1px); }
    button:active { background: var(--btn-active); transform: scale(0.96); }
    button.operator { background: var(--op-bg); border-color: var(--op-text); color: var(--op-text); }
    button.equals { background: var(--eq-bg); grid-column: span 2; }
    button.clear { background: var(--clear-bg); border-color: var(--op-text); color: var(--op-text); }
    button.mode-btn { background: var(--mode-bg); border-color: var(--mode-text); color: var(--mode-text); grid-column: span 2; }
    button.theme-btn { background: var(--theme-bg); color: var(--theme-text); }
    button.export-btn { background: var(--export-bg); color: var(--export-text); }
    .hex-only { display: none; }
  </style>
</head>
<body data-theme="matrix">

<div class="calculator">
  <div class="mode" id="mode">System: DEC</div>
  <div class="display" id="display">0</div>
  <div class="buttons">
    <button class="clear" onclick="clearDisplay()">C</button>
    <button onclick="deleteLast()">backspace</button>
    <button class="operator" onclick="appendOperator('/')">/</button>
    <button class="operator" onclick="appendOperator('*')">×</button>

    <button class="mode-btn" onclick="toggleMode()">System</button>
    <button class="theme-btn" onclick="cycleTheme()">Theme</button>

    <button onclick="appendToDisplay('7')">7</button>
    <button onclick="appendToDisplay('8')">8</button>
    <button onclick="appendToDisplay('9')">9</button>
    <button class="operator" onclick="appendOperator('-')">-</button>

    <button onclick="appendToDisplay('4')">4</button>
    <button onclick="appendToDisplay('5')">5</button>
    <button onclick="appendToDisplay('6')">6</button>
    <button class="operator" onclick="appendOperator('+')">+</button>

    <button onclick="appendToDisplay('1')">1</button>
    <button onclick="appendToDisplay('2')">2</button>
    <button onclick="appendToDisplay('3')">3</button>
    <button class="equals" onclick="calculate()">=</button>

    <button onclick="appendToDisplay('0')" style="grid-column: span 2;">0</button>
    <button onclick="appendToDisplay('.')">.</button>

    <button class="hex-only" onclick="appendToDisplay('A')">A</button>
    <button class="hex-only" onclick="appendToDisplay('B')">B</button>
    <button class="hex-only" onclick="appendToDisplay('C')">C</button>
    <button class="hex-only" onclick="appendToDisplay('D')">D</button>
    <button class="hex-only" onclick="appendToDisplay('E')">E</button>
    <button class="hex-only" onclick="appendToDisplay('F')">F</button>

    <button class="export-btn" onclick="exportToHTML()">Export</button>
  </div>
</div>

<script>
  const display = document.getElementById('display');
  const modeText = document.getElementById('mode');
  const hexButtons = document.querySelectorAll('.hex-only');
  const body = document.body;
  let mode = 'DEC';
  let internalExpr = '0';
  let lastResult = '';
  let lastOperator = '';
  let history = [];
  const MAX_DIGITS = 100000;
  const themes = ['matrix', 'ocean', 'sunset'];
  let currentTheme = 0;

  function updateDisplay() {
    const reversed = internalExpr.split('').reverse().join('');
    display.innerText = reversed || '0';
    requestAnimationFrame(() => {
      display.scrollLeft = 0;
    });
  }

  function loadState() {
    const saved = JSON.parse(localStorage.getItem('systemCalc') || '{}');
    mode = saved.mode || 'DEC';
    internalExpr = saved.expr || '0';
    lastResult = saved.result || '';
    lastOperator = saved.op || '';
    history = saved.history || [];
    currentTheme = themes.indexOf(saved.theme || 'matrix');
    if (currentTheme === -1) currentTheme = 0;
    body.setAttribute('data-theme', themes[currentTheme]);
    updateMode();
    updateDisplay();
  }

  function saveState() {
    const state = { mode, expr: internalExpr, result: lastResult, op: lastOperator, history, theme: themes[currentTheme] };
    localStorage.setItem('systemCalc', JSON.stringify(state));
  }

  function appendToDisplay(value) {
    if (internalExpr === '0' && value !== '.') {
      internalExpr = value;
    } else if (internalExpr.length < MAX_DIGITS) {
      internalExpr += value;
    }
    const lastChar = internalExpr.slice(-1);
    if (!isNaN(lastChar) || lastChar === '.') {
      lastResult = '';
    }
    updateDisplay();
    saveState();
  }

  function appendOperator(op) {
    const lastChar = internalExpr.slice(-1);
    if (['+', '-', '*', '/', '×'].includes(lastChar)) {
      internalExpr = internalExpr.slice(0, -1);
    }

    let expressionToHistory = internalExpr;
    if (lastResult && internalExpr === lastResult) {
      expressionToHistory = lastResult;
    }

    const historyLine = expressionToHistory.replace('×', '*') + ' ' + op.replace('×', '*');
    history.push(historyLine);

    internalExpr += op;
    lastOperator = op;
    updateDisplay();
    saveState();
  }

  function clearDisplay() {
    internalExpr = '0';
    lastResult = '';
    lastOperator = '';
    history = [];
    updateDisplay();
    saveState();
  }

  function deleteLast() {
    internalExpr = internalExpr.length > 1 ? internalExpr.slice(0, -1) : '0';
    updateDisplay();
    saveState();
  }

  function toggleMode() {
    mode = mode === 'DEC' ? 'HEX' : 'DEC';
    updateMode();
    if (mode === 'DEC') {
      internalExpr = internalExpr.replace(/[A-F.]/gi, '');
      if (!internalExpr || internalExpr.match(/^[+\-*/]$/)) internalExpr = '0';
    }
    updateDisplay();
    saveState();
  }

  function updateMode() {
    modeText.innerText = `System: ${mode}`;
    hexButtons.forEach(btn => btn.style.display = mode === 'HEX' ? 'block' : 'none');
  }

  function cycleTheme() {
    currentTheme = (currentTheme + 1) % themes.length;
    body.setAttribute('data-theme', themes[currentTheme]);
    saveState();
  }

  function calculate() {
    if (internalExpr === '0') return;

    try {
      let expr = internalExpr.replace(/([+\-*/×])$/, '').replace(/×/g, '*');

      let result;
      if (mode === 'HEX') {
        expr = expr.replace(/([0-9A-F]+)/gi, m => `0x${m}`);
        result = eval(expr.replace(/0x([0-9A-F]+)/gi, 'BigInt("0x$1")'));
        internalExpr = result.toString(16).toUpperCase();
      } else {
        result = eval(expr.replace(/\d+/g, n => `BigInt("${n}")`));
        internalExpr = result.toString();
      }

      lastResult = internalExpr;
      history.push(`= ${lastResult}`);
    } catch (e) {
      internalExpr = 'ERROR';
      setTimeout(() => { if (internalExpr === 'ERROR') clearDisplay(); }, 2000);
    }

    if (internalExpr.length > MAX_DIGITS) {
      internalExpr = internalExpr.slice(0, MAX_DIGITS) + '...';
    }
    updateDisplay();
    saveState();
  }

  function exportToHTML() {
    const timestamp = new Date().toLocaleString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true });
    const historyHTML = history.map(line => `<div style="margin: 10px 0; padding: 14px; background: #111; color: #0f0; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 1.1em; word-break: break-all; white-space: pre-wrap;">${line}</div>`).join('');
    const finalResult = lastResult || internalExpr;

    const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Calculator Result - ${timestamp}</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f9f9f9; color: #222; padding: 40px; text-align: center; }
    .container { max-width: 700px; margin: 0 auto; background: white; padding: 35px; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    h1 { font-size: 2.4em; margin-bottom: 10px; color: #222; }
    .subtitle { color: #666; font-size: 1.1em; margin-bottom: 35px; border-bottom: 1px solid #ddd; padding-bottom: 12px; }
    .section { margin: 30px 0; text-align: left; }
    .label { font-weight: bold; color: #444; margin-bottom: 12px; font-size: 1.1em; }
    .history { background: #f0f0f0; padding: 18px; border-radius: 14px; }
    .history div { word-break: break-all; white-space: pre-wrap; margin: 8px 0; }
    .result-box { background: #e9e9e9; padding: 25px; border-radius: 14px; font-size: 1.9em; font-weight: bold; margin: 25px 0; font-family: 'Courier New', monospace; color: #0a0; word-break: break-all; }
    .note { font-size: 0.95em; color: #777; margin-top: 25px; font-style: italic; line-height: 1.5; }
  </style>
</head>
<body>
  <div class="container">
    <h1>System<br>Calculator Result</h1>
    <div class="subtitle">Timestamp: ${timestamp}</div>

    <div class="section">
      <div class="label">Calculation History:</div>
      <div class="history">${historyHTML || '<em style="color: #888;">No operations</em>'}</div>
    </div>

    <div class="section">
      <div class="label">Final Result:</div>
      <div class="result-box">${finalResult}</div>
    </div>

    <div class="note">
      Note: This result was calculated with a division precision of 20000 digits using a chaining operation system.
    </div>
  </div>
</body>
</html>`;

    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `System_Calculator_Result_${Date.now()}.html`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Init
  loadState();
  window.addEventListener('beforeunload', saveState);
</script>

</body>
</html>